{% extends 'base.html' %}
{% load number_format %}

{% block content %}

    <div class="container" x-data="{ base: 'python' }">
        <h1>Django Matrix Compatibility</h1><br/>

        <p>
            Welcome to <b>Django Matrix</b>,
            your go-to resource for exploring Django versions, package compatibility, and version comparisons.
            Here, you can find detailed information about different Django releases, their compatibility with Python versions, and popular packages.
            You can also browse or request packages, compare features between versions, and ensure your projects are built on a solid, compatible foundation.
            Whether you're starting a new project or maintaining an existing one, this site helps you make informed decisions quickly and efficiently.
        </p>

        <div class="container" style="position: relative; margin-bottom: 20px;" x-data="searchComponent()" @click.away="clearAll()">
            <h1>Search for a Package</h1>

            <!-- Search Input -->
            <input x-model="query" @input="fetchPackages" type="text"
                   class="form-control" placeholder="Search for a package/library name...">

            <!-- Results Table -->
            <template x-if="results.length > 0">
              <table class="table table-striped mt-1 autocomplete-dropdown">
                <tbody>
                  <template x-for="pkg in results" :key="pkg.id">
                    <tr class="autocomplete-row" @click="selectPackage(pkg)">
                      <td x-text="pkg.name"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </template>
        </div>

        <div class="row" >
            <div class="col-md-6">

                <!-- Toggle Form -->
                <form class="toggle-form" style="margin-bottom: -10px;">
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="radio"
                            id="basePython"
                            value="python"
                            x-model="base"
                            checked
                        >
                        <label class="form-check-label" for="basePython">Python as Base</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="radio"
                            id="baseDjango"
                            value="django"
                            x-model="base"
                        >
                        <label class="form-check-label" for="baseDjango">Django as Base</label>
                    </div>
                </form>

                <!-- Python-based Compatibility Table -->
                <div x-show="base === 'python'" x-cloak>
                    <table class="table table-striped compatibility-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Python Version</th>
                                <th>Compatible Django Versions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for python in python_versions %}
                                <tr>
                                    <td>{{ python.verbose_name }}</td>
                                    <td>
                                        {% if python.compatibilities.exists %}
                                            Django
                                            {% for compat in python.compatibilities.all %}
                                                {{ compat.django_version.version }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <em>No compatible Django versions found.</em>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="2">No compatibility data available.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Django-based Compatibility Table -->
                <div x-show="base === 'django'" x-cloak>
                    <table class="table table-striped compatibility-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Django Version</th>
                                <th>Compatible Python Versions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for django in django_versions %}
                                <tr>
                                    <td>{{ django.verbose_name }}</td>
                                    <td>
                                        {% if django.compatibilities.exists %}
                                            Python
                                            {% for compat in django.compatibilities.all %}
                                                {{ compat.python_version.version }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <em>No compatible Python versions found.</em>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="2">No compatibility data available.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <div class="container">
                    <h2>Most Popular Django packages </h2><small>By GitHub Stars</small>
                    <ol>
                        {% for package in most_popular_packages %}
                            <li><a href="{% url 'package_details' package.slug %}">{{ package }}</a>  - {{ package.metric_stars|round_to_hundreds }}</li>
                        {% endfor %}
                    </ol>
                    <a href="{% url 'packages' %}">List all packages</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function searchComponent() {
          return {
            query: '',
            results: [],
            fetchPackages() {
              // if query is empty, clear the results and skip the request
              if (this.query.length < 1) {
                this.results = [];
                return;
              }
              fetch(`/packages/search/?q=${encodeURIComponent(this.query)}`)
                .then(response => response.json())
                .then(data => {
                  this.results = data.results;
                })
                .catch(error => {
                  console.error('Error fetching packages:', error);
                  this.results = [];
                });
            },
            selectPackage(pkg) {
              window.location.href = `/packages/${pkg.slug}/`;
            },
            clearAll() {
                this.query = '';
                this.results = [];
            }
          }
        }
      </script>


{% endblock %}